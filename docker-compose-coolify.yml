version: '3.8'

services:
  mongodb:
    image: mongo:latest
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    ports:
      - "27017"
    volumes:
      - ./mongo-data:/data/db
    # Pin the MongoDB container to a static address on the internal network

  # Build an image from the repository once and reuse it for all GenieACS services
  genieacs-build:
    build:
      context: .
      dockerfile: Dockerfile
    image: genieacs-base
    command: ["sleep", "infinity"]

  # GenieACS UI service listening on all interfaces with a fixed IP
  ui:
    image: genieacs-base
    working_dir: /app
    command: sh -c "npm install && node bin/genieacs-ui"
    ports:
      - "3000"
    environment:
      GENIEACS_MONGODB_CONNECTION_URL: mongodb://root:password@mongodb:27017/genieacs?authSource=admin
      GENIEACS_DEBUG_FILE: /app/genieacs-debug.yaml
      GENIEACS_UI_JWT_SECRET: change-this-secret
      GENIEACS_UI_INTERFACE: 0.0.0.0
    depends_on:
      - mongodb

  # GenieACS CWMP service (ACS server) with extensions directory mounted
  cwmp:
    image: genieacs-base
    working_dir: /app
    command: sh -c "npm install && node bin/genieacs-cwmp"
    ports:
      - "7547"
    environment:
      GENIEACS_MONGODB_CONNECTION_URL: mongodb://root:password@mongodb:27017/genieacs?authSource=admin
      GENIEACS_DEBUG_FILE: /app/genieacs-debug.yaml
      GENIEACS_EXT_DIR: /opt/genieacs/ext
      GENIEACS_CWMP_INTERFACE: 100.67.0.5
    volumes:
      - ./ext:/opt/genieacs/ext
    depends_on:
      - mongodb

  # GenieACS NBI service for API access
  nbi:
    image: genieacs-base
    working_dir: /app
    command: sh -c "npm install && node bin/genieacs-nbi"
    ports:
      - "7557"
    environment:
      GENIEACS_MONGODB_CONNECTION_URL: mongodb://root:password@mongodb:27017/genieacs?authSource=admin
      GENIEACS_NBI_INTERFACE: 0.0.0.0
    depends_on:
      - mongodb

  # GenieACS File Server service
  fs:
    image: genieacs-base
    working_dir: /app
    command: sh -c "npm install && node bin/genieacs-fs"
    ports:
      - "7567"
    environment:
      GENIEACS_MONGODB_CONNECTION_URL: mongodb://root:password@mongodb:27017/genieacs?authSource=admin
      GENIEACS_FS_INTERFACE: 0.0.0.0
    depends_on:
      - mongodb

    image: ghcr.io/wg-easy/wg-easy
    container_name: wg-easy
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      # Ganti dengan domain publik atau IP server untuk akses VPN
      WG_HOST: vpn1.dev.kejora.net
      # Kata sandi untuk antarmuka web wg-easy
      #PASSWORD: change-me
      # Subnet untuk klien WireGuard
      WG_DEFAULT_ADDRESS: 10.8.0.0
      # DNS yang diberikan ke klien
      WG_DEFAULT_DNS: 8.8.8.8
      # Subnet internal Docker dimana GenieACS berada sehingga klien VPN bisa merutekannya
      WG_ALLOWED_IPS: 172.25.0.0/24
    volumes:
      - ./wg-easy-config:/etc/wireguard
    ports:
      - "51821/tcp" # UI wg-easy
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1

networks:
  genie-net:
    driver: bridge